<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTBots API 调试工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .section h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .code-block {
            background-color: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 GPTBots API 调试工具</h1>
        
        <div class="section">
            <h3>📋 API 配置</h3>
            <div class="input-group">
                <label for="apiKey">API 密钥:</label>
                <input type="text" id="apiKey" value="app-nHIn7Ghs7maO6D3vVpnLm489">
            </div>
            <div class="input-group">
                <label for="userId">用户ID:</label>
                <input type="text" id="userId" value="debug-user-001">
            </div>
        </div>

        <div class="section">
            <h3>🔗 步骤1：创建对话</h3>
            <p>测试创建对话API的原始响应</p>
            <div class="code-block">
curl -X POST https://api.gptbots.ai/v1/conversation \
  -H 'Authorization: Bearer app-nHIn7Ghs7maO6D3vVpnLm489' \
  -H 'Content-Type: application/json' \
  -d '{"user_id": "debug-user-001"}'
            </div>
            <button onclick="debugCreateConversation()">测试创建对话</button>
            <div id="createResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>📤 步骤2：发送消息</h3>
            <p>测试发送消息API的原始响应（需要先创建对话）</p>
            <div class="input-group">
                <label for="conversationId">对话ID:</label>
                <input type="text" id="conversationId" placeholder="从步骤1获得的对话ID">
            </div>
            <div class="input-group">
                <label for="testMessage">测试消息:</label>
                <textarea id="testMessageDebug" placeholder="输入测试消息...">你好，请介绍一下你自己。</textarea>
            </div>
            <button onclick="debugSendMessage()">测试发送消息</button>
            <div id="messageResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>🔍 响应分析</h3>
            <p>分析API响应结构，找出正确的字段名</p>
            <div id="analysisResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>📝 建议的配置</h3>
            <p>根据实际响应生成正确的配置代码</p>
            <div id="configSuggestion" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let rawCreateResponse = null;
        let rawMessageResponse = null;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        async function debugCreateConversation() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const userId = document.getElementById('userId').value;

                if (!apiKey || !userId) {
                    showResult('createResult', '请填写API密钥和用户ID', 'error');
                    return;
                }

                showResult('createResult', '正在调用创建对话API...', 'info');

                // 使用本地代理服务器（如果可用），否则直接调用API
                const apiUrl = window.location.hostname === 'localhost' && window.location.port === '8080' 
                    ? 'http://localhost:8081/api/v1/conversation'
                    : 'https://api.gptbots.ai/v1/conversation';
                
                const headers = apiUrl.includes('localhost') 
                    ? { 'Content-Type': 'application/json' }  // 本地代理会自动添加Authorization
                    : { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        user_id: userId
                    })
                });

                const responseText = await response.text();
                
                try {
                    rawCreateResponse = JSON.parse(responseText);
                } catch (e) {
                    rawCreateResponse = responseText;
                }

                const resultHtml = `
<strong>HTTP 状态码:</strong> ${response.status} ${response.statusText}

<strong>响应头:</strong>
${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}

<strong>响应体:</strong>
${typeof rawCreateResponse === 'object' ? JSON.stringify(rawCreateResponse, null, 2) : rawCreateResponse}

<strong>响应体类型:</strong> ${typeof rawCreateResponse}
                `;

                if (response.ok) {
                    showResult('createResult', resultHtml, 'success');
                    
                    // 尝试提取对话ID
                    if (typeof rawCreateResponse === 'object') {
                        const possibleIds = [
                            rawCreateResponse.conversation_id,
                            rawCreateResponse.id,
                            rawCreateResponse.data?.conversation_id,
                            rawCreateResponse.data?.id,
                            rawCreateResponse.result?.conversation_id,
                            rawCreateResponse.result?.id
                        ].filter(id => id);
                        
                        if (possibleIds.length > 0) {
                            document.getElementById('conversationId').value = possibleIds[0];
                        }
                    }
                    
                    analyzeResponse();
                } else {
                    showResult('createResult', resultHtml, 'error');
                }

            } catch (error) {
                showResult('createResult', `请求失败: ${error.message}`, 'error');
            }
        }

        async function debugSendMessage() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const conversationId = document.getElementById('conversationId').value;
                const message = document.getElementById('testMessageDebug').value;

                if (!apiKey || !conversationId || !message) {
                    showResult('messageResult', '请填写所有必需字段', 'error');
                    return;
                }

                showResult('messageResult', '正在调用发送消息API...', 'info');

                const requestBody = {
                    conversation_id: conversationId,
                    response_mode: "blocking",
                    messages: [
                        {
                            role: "user",
                            content: message
                        }
                    ],
                    conversation_config: {
                        long_term_memory: false,
                        short_term_memory: false
                    }
                };

                const apiUrl = window.location.hostname === 'localhost' && window.location.port === '8080' 
                    ? 'http://localhost:8081/api/v2/conversation/message'
                    : 'https://api.gptbots.ai/v2/conversation/message';
                
                const headers = apiUrl.includes('localhost') 
                    ? { 'Content-Type': 'application/json' }
                    : { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();
                
                try {
                    rawMessageResponse = JSON.parse(responseText);
                } catch (e) {
                    rawMessageResponse = responseText;
                }

                const resultHtml = `
<strong>HTTP 状态码:</strong> ${response.status} ${response.statusText}

<strong>请求体:</strong>
${JSON.stringify(requestBody, null, 2)}

<strong>响应头:</strong>
${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}

<strong>响应体:</strong>
${typeof rawMessageResponse === 'object' ? JSON.stringify(rawMessageResponse, null, 2) : rawMessageResponse}

<strong>响应体类型:</strong> ${typeof rawMessageResponse}
                `;

                if (response.ok) {
                    showResult('messageResult', resultHtml, 'success');
                    analyzeResponse();
                } else {
                    showResult('messageResult', resultHtml, 'error');
                }

            } catch (error) {
                showResult('messageResult', `请求失败: ${error.message}`, 'error');
            }
        }

        function analyzeResponse() {
            let analysis = '<strong>📊 响应结构分析:</strong>\n\n';
            
            if (rawCreateResponse) {
                analysis += '<strong>创建对话响应分析:</strong>\n';
                analysis += `类型: ${typeof rawCreateResponse}\n`;
                
                if (typeof rawCreateResponse === 'object') {
                    analysis += '可能的对话ID字段:\n';
                    const keys = Object.keys(rawCreateResponse);
                    keys.forEach(key => {
                        analysis += `  - ${key}: ${JSON.stringify(rawCreateResponse[key])}\n`;
                    });
                }
                analysis += '\n';
            }
            
            if (rawMessageResponse) {
                analysis += '<strong>发送消息响应分析:</strong>\n';
                analysis += `类型: ${typeof rawMessageResponse}\n`;
                
                if (typeof rawMessageResponse === 'object') {
                    analysis += '可能的消息内容字段:\n';
                    const keys = Object.keys(rawMessageResponse);
                    keys.forEach(key => {
                        analysis += `  - ${key}: ${JSON.stringify(rawMessageResponse[key])}\n`;
                    });
                }
                analysis += '\n';
            }
            
            showResult('analysisResult', analysis, 'info');
            generateConfigSuggestion();
        }

        function generateConfigSuggestion() {
            if (!rawCreateResponse && !rawMessageResponse) {
                return;
            }
            
            let suggestion = '<strong>🔧 建议的API配置:</strong>\n\n';
            
            suggestion += 'responseMapping: {\n';
            
            if (rawCreateResponse && typeof rawCreateResponse === 'object') {
                const possibleIdFields = ['conversation_id', 'id', 'data.conversation_id', 'data.id', 'result.conversation_id', 'result.id'];
                const idField = possibleIdFields.find(field => {
                    const value = field.includes('.') ? 
                        field.split('.').reduce((obj, key) => obj?.[key], rawCreateResponse) : 
                        rawCreateResponse[field];
                    return value;
                }) || 'conversation_id';
                
                suggestion += `    conversationId: '${idField}',\n`;
            }
            
            if (rawMessageResponse && typeof rawMessageResponse === 'object') {
                const possibleMessageFields = ['output[0].content.text', 'answer', 'message', 'content', 'response', 'text', 'data.answer', 'data.message', 'result.answer', 'result.message'];
                const messageField = possibleMessageFields.find(field => {
                    if (field === 'output[0].content.text') {
                        return rawMessageResponse.output && rawMessageResponse.output[0] && rawMessageResponse.output[0].content && rawMessageResponse.output[0].content.text;
                    }
                    const value = field.includes('.') ? 
                        field.split('.').reduce((obj, key) => obj?.[key], rawMessageResponse) : 
                        rawMessageResponse[field];
                    return value;
                }) || 'output[0].content.text';
                
                suggestion += `    message: '${messageField}',\n`;
            }
            
            suggestion += '    error: \'message\',\n';
            suggestion += '    status: \'code\'\n';
            suggestion += '}\n\n';
            
            suggestion += '<strong>📋 复制以下代码到 api-config.js:</strong>\n';
            suggestion += `
// 根据实际API响应更新配置
const API_CONFIG = {
    baseUrl: 'https://api.gptbots.ai',
    createConversationEndpoint: '/v1/conversation',
    chatEndpoint: '/v2/conversation/message',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ${document.getElementById('apiKey').value}'
    },
    responseMapping: {
        conversationId: 'conversation_id', // 请根据实际响应调整
        message: 'answer',                 // 请根据实际响应调整
        error: 'message',
        status: 'code'
    }
};
            `;
            
            showResult('configSuggestion', suggestion, 'success');
        }
    </script>
</body>
</html> 