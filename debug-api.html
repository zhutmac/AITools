<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPTBots API è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .section h3 {
            margin-top: 0;
            color: #007bff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .code-block {
            background-color: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ GPTBots API è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“‹ API é…ç½®</h3>
            <div class="input-group">
                <label for="apiKey">API å¯†é’¥:</label>
                <input type="text" id="apiKey" value="app-nHIn7Ghs7maO6D3vVpnLm489">
            </div>
            <div class="input-group">
                <label for="userId">ç”¨æˆ·ID:</label>
                <input type="text" id="userId" value="debug-user-001">
            </div>
        </div>

        <div class="section">
            <h3>ğŸ”— æ­¥éª¤1ï¼šåˆ›å»ºå¯¹è¯</h3>
            <p>æµ‹è¯•åˆ›å»ºå¯¹è¯APIçš„åŸå§‹å“åº”</p>
            <div class="code-block">
curl -X POST https://api.gptbots.ai/v1/conversation \
  -H 'Authorization: Bearer app-nHIn7Ghs7maO6D3vVpnLm489' \
  -H 'Content-Type: application/json' \
  -d '{"user_id": "debug-user-001"}'
            </div>
            <button onclick="debugCreateConversation()">æµ‹è¯•åˆ›å»ºå¯¹è¯</button>
            <div id="createResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>ğŸ“¤ æ­¥éª¤2ï¼šå‘é€æ¶ˆæ¯</h3>
            <p>æµ‹è¯•å‘é€æ¶ˆæ¯APIçš„åŸå§‹å“åº”ï¼ˆéœ€è¦å…ˆåˆ›å»ºå¯¹è¯ï¼‰</p>
            <div class="input-group">
                <label for="conversationId">å¯¹è¯ID:</label>
                <input type="text" id="conversationId" placeholder="ä»æ­¥éª¤1è·å¾—çš„å¯¹è¯ID">
            </div>
            <div class="input-group">
                <label for="testMessage">æµ‹è¯•æ¶ˆæ¯:</label>
                <textarea id="testMessageDebug" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯...">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚</textarea>
            </div>
            <button onclick="debugSendMessage()">æµ‹è¯•å‘é€æ¶ˆæ¯</button>
            <div id="messageResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>ğŸ” å“åº”åˆ†æ</h3>
            <p>åˆ†æAPIå“åº”ç»“æ„ï¼Œæ‰¾å‡ºæ­£ç¡®çš„å­—æ®µå</p>
            <div id="analysisResult" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>ğŸ“ å»ºè®®çš„é…ç½®</h3>
            <p>æ ¹æ®å®é™…å“åº”ç”Ÿæˆæ­£ç¡®çš„é…ç½®ä»£ç </p>
            <div id="configSuggestion" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        let rawCreateResponse = null;
        let rawMessageResponse = null;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        async function debugCreateConversation() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const userId = document.getElementById('userId').value;

                if (!apiKey || !userId) {
                    showResult('createResult', 'è¯·å¡«å†™APIå¯†é’¥å’Œç”¨æˆ·ID', 'error');
                    return;
                }

                showResult('createResult', 'æ­£åœ¨è°ƒç”¨åˆ›å»ºå¯¹è¯API...', 'info');

                // ä½¿ç”¨æœ¬åœ°ä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨API
                const apiUrl = window.location.hostname === 'localhost' && window.location.port === '8080' 
                    ? 'http://localhost:8081/api/v1/conversation'
                    : 'https://api.gptbots.ai/v1/conversation';
                
                const headers = apiUrl.includes('localhost') 
                    ? { 'Content-Type': 'application/json' }  // æœ¬åœ°ä»£ç†ä¼šè‡ªåŠ¨æ·»åŠ Authorization
                    : { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        user_id: userId
                    })
                });

                const responseText = await response.text();
                
                try {
                    rawCreateResponse = JSON.parse(responseText);
                } catch (e) {
                    rawCreateResponse = responseText;
                }

                const resultHtml = `
<strong>HTTP çŠ¶æ€ç :</strong> ${response.status} ${response.statusText}

<strong>å“åº”å¤´:</strong>
${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}

<strong>å“åº”ä½“:</strong>
${typeof rawCreateResponse === 'object' ? JSON.stringify(rawCreateResponse, null, 2) : rawCreateResponse}

<strong>å“åº”ä½“ç±»å‹:</strong> ${typeof rawCreateResponse}
                `;

                if (response.ok) {
                    showResult('createResult', resultHtml, 'success');
                    
                    // å°è¯•æå–å¯¹è¯ID
                    if (typeof rawCreateResponse === 'object') {
                        const possibleIds = [
                            rawCreateResponse.conversation_id,
                            rawCreateResponse.id,
                            rawCreateResponse.data?.conversation_id,
                            rawCreateResponse.data?.id,
                            rawCreateResponse.result?.conversation_id,
                            rawCreateResponse.result?.id
                        ].filter(id => id);
                        
                        if (possibleIds.length > 0) {
                            document.getElementById('conversationId').value = possibleIds[0];
                        }
                    }
                    
                    analyzeResponse();
                } else {
                    showResult('createResult', resultHtml, 'error');
                }

            } catch (error) {
                showResult('createResult', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function debugSendMessage() {
            try {
                const apiKey = document.getElementById('apiKey').value;
                const conversationId = document.getElementById('conversationId').value;
                const message = document.getElementById('testMessageDebug').value;

                if (!apiKey || !conversationId || !message) {
                    showResult('messageResult', 'è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
                    return;
                }

                showResult('messageResult', 'æ­£åœ¨è°ƒç”¨å‘é€æ¶ˆæ¯API...', 'info');

                const requestBody = {
                    conversation_id: conversationId,
                    response_mode: "blocking",
                    messages: [
                        {
                            role: "user",
                            content: message
                        }
                    ],
                    conversation_config: {
                        long_term_memory: false,
                        short_term_memory: false
                    }
                };

                const apiUrl = window.location.hostname === 'localhost' && window.location.port === '8080' 
                    ? 'http://localhost:8081/api/v2/conversation/message'
                    : 'https://api.gptbots.ai/v2/conversation/message';
                
                const headers = apiUrl.includes('localhost') 
                    ? { 'Content-Type': 'application/json' }
                    : { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();
                
                try {
                    rawMessageResponse = JSON.parse(responseText);
                } catch (e) {
                    rawMessageResponse = responseText;
                }

                const resultHtml = `
<strong>HTTP çŠ¶æ€ç :</strong> ${response.status} ${response.statusText}

<strong>è¯·æ±‚ä½“:</strong>
${JSON.stringify(requestBody, null, 2)}

<strong>å“åº”å¤´:</strong>
${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}

<strong>å“åº”ä½“:</strong>
${typeof rawMessageResponse === 'object' ? JSON.stringify(rawMessageResponse, null, 2) : rawMessageResponse}

<strong>å“åº”ä½“ç±»å‹:</strong> ${typeof rawMessageResponse}
                `;

                if (response.ok) {
                    showResult('messageResult', resultHtml, 'success');
                    analyzeResponse();
                } else {
                    showResult('messageResult', resultHtml, 'error');
                }

            } catch (error) {
                showResult('messageResult', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function analyzeResponse() {
            let analysis = '<strong>ğŸ“Š å“åº”ç»“æ„åˆ†æ:</strong>\n\n';
            
            if (rawCreateResponse) {
                analysis += '<strong>åˆ›å»ºå¯¹è¯å“åº”åˆ†æ:</strong>\n';
                analysis += `ç±»å‹: ${typeof rawCreateResponse}\n`;
                
                if (typeof rawCreateResponse === 'object') {
                    analysis += 'å¯èƒ½çš„å¯¹è¯IDå­—æ®µ:\n';
                    const keys = Object.keys(rawCreateResponse);
                    keys.forEach(key => {
                        analysis += `  - ${key}: ${JSON.stringify(rawCreateResponse[key])}\n`;
                    });
                }
                analysis += '\n';
            }
            
            if (rawMessageResponse) {
                analysis += '<strong>å‘é€æ¶ˆæ¯å“åº”åˆ†æ:</strong>\n';
                analysis += `ç±»å‹: ${typeof rawMessageResponse}\n`;
                
                if (typeof rawMessageResponse === 'object') {
                    analysis += 'å¯èƒ½çš„æ¶ˆæ¯å†…å®¹å­—æ®µ:\n';
                    const keys = Object.keys(rawMessageResponse);
                    keys.forEach(key => {
                        analysis += `  - ${key}: ${JSON.stringify(rawMessageResponse[key])}\n`;
                    });
                }
                analysis += '\n';
            }
            
            showResult('analysisResult', analysis, 'info');
            generateConfigSuggestion();
        }

        function generateConfigSuggestion() {
            if (!rawCreateResponse && !rawMessageResponse) {
                return;
            }
            
            let suggestion = '<strong>ğŸ”§ å»ºè®®çš„APIé…ç½®:</strong>\n\n';
            
            suggestion += 'responseMapping: {\n';
            
            if (rawCreateResponse && typeof rawCreateResponse === 'object') {
                const possibleIdFields = ['conversation_id', 'id', 'data.conversation_id', 'data.id', 'result.conversation_id', 'result.id'];
                const idField = possibleIdFields.find(field => {
                    const value = field.includes('.') ? 
                        field.split('.').reduce((obj, key) => obj?.[key], rawCreateResponse) : 
                        rawCreateResponse[field];
                    return value;
                }) || 'conversation_id';
                
                suggestion += `    conversationId: '${idField}',\n`;
            }
            
            if (rawMessageResponse && typeof rawMessageResponse === 'object') {
                const possibleMessageFields = ['output[0].content.text', 'answer', 'message', 'content', 'response', 'text', 'data.answer', 'data.message', 'result.answer', 'result.message'];
                const messageField = possibleMessageFields.find(field => {
                    if (field === 'output[0].content.text') {
                        return rawMessageResponse.output && rawMessageResponse.output[0] && rawMessageResponse.output[0].content && rawMessageResponse.output[0].content.text;
                    }
                    const value = field.includes('.') ? 
                        field.split('.').reduce((obj, key) => obj?.[key], rawMessageResponse) : 
                        rawMessageResponse[field];
                    return value;
                }) || 'output[0].content.text';
                
                suggestion += `    message: '${messageField}',\n`;
            }
            
            suggestion += '    error: \'message\',\n';
            suggestion += '    status: \'code\'\n';
            suggestion += '}\n\n';
            
            suggestion += '<strong>ğŸ“‹ å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ° api-config.js:</strong>\n';
            suggestion += `
// æ ¹æ®å®é™…APIå“åº”æ›´æ–°é…ç½®
const API_CONFIG = {
    baseUrl: 'https://api.gptbots.ai',
    createConversationEndpoint: '/v1/conversation',
    chatEndpoint: '/v2/conversation/message',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ${document.getElementById('apiKey').value}'
    },
    responseMapping: {
        conversationId: 'conversation_id', // è¯·æ ¹æ®å®é™…å“åº”è°ƒæ•´
        message: 'answer',                 // è¯·æ ¹æ®å®é™…å“åº”è°ƒæ•´
        error: 'message',
        status: 'code'
    }
};
            `;
            
            showResult('configSuggestion', suggestion, 'success');
        }
    </script>
</body>
</html> 